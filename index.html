<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hành Trình 60 Ngày Xóa Điếc</title>
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;0,900;1,400&family=Roboto:wght@300;400;700&display=swap');
        
        body { font-family: 'Roboto', sans-serif; margin: 0; padding: 0; }
        .font-serif { font-family: 'Playfair Display', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-in { animation: fadeIn 0.5s ease-out forwards; }
        
        #fallback-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f5f5f4; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 9999;
        }
    </style>
</head>
<body class="bg-stone-50">
    <!-- Màn hình chờ nếu React chưa load xong -->
    <div id="fallback-loader">
        <div style="width: 40px; height: 40px; border: 4px solid #78350f; border-top: 4px solid transparent; border-radius: 50%; animate: spin 1s linear infinite;"></div>
        <p style="margin-top: 20px; color: #78350f; font-weight: bold; font-family: sans-serif; letter-spacing: 2px;">KHỞI TẠO TÂM THỨC...</p>
        <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
    </div>

    <div id="root"></div>

    <!-- Firebase SDKs - Sử dụng bản Compat để ổn định hơn trong file đơn -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // Cấu hình Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC9NLtRzq6_pnt3-viN6a31WbLu_sMlGEI",
            authDomain: "day-challenge-39df2.firebaseapp.com",
            projectId: "day-challenge-39df2",
            storageBucket: "day-challenge-39df2.firebasestorage.app",
            messagingSenderId: "1083656610996",
            appId: "1:1083656610996:web:67780223432a21866323e1"
        };

        // Khởi tạo Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = "sixty-day-challenge-v1";

        // Thành phần Icon an toàn
        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            
            return <i data-lucide={name.toLowerCase().replace(/([a-z])([A-Z])/g, '$1-$2')} style={{width: size, height: size}} className={className}></i>;
        };

        const App = () => {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [passInput, setPassInput] = useState("");
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [selectedMember, setSelectedMember] = useState(0);
            const [viewDay, setViewDay] = useState(1);
            const [todayNum, setTodayNum] = useState(1);
            const [data, setData] = useState({}); 
            const [viewMode, setViewMode] = useState('leaderboard'); 
            const [activeLesson, setActiveLesson] = useState(null);

            const TOTAL_DAYS = 60;
            const START_DATE = new Date('2026-01-23'); 
            const PASSWORD = "elephan";
            const MEMBERS = ["Bảo Bình", "Bình Minh", "Phượng", "Phương", "Trang", "Điện", "Ánh Dương", "Thanh Thảo", "Linh", "Quân", "Hằng"];

            useEffect(() => {
                // Tắt màn hình chờ sau khi React sẵn sàng
                const loader = document.getElementById('fallback-loader');
                if (loader) loader.style.display = 'none';

                // Lắng nghe Auth
                const unsubscribe = auth.onAuthStateChanged((u) => {
                    if (u) {
                        setUser(u);
                        setLoading(false);
                    } else {
                        auth.signInAnonymously().catch(console.error);
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                const path = `artifacts/${appId}/public/data/v2_challenges`;
                const unsubscribe = db.collection(path).onSnapshot((snapshot) => {
                    const newData = {};
                    snapshot.forEach((doc) => { newData[doc.id] = doc.data(); });
                    setData(newData);
                }, (error) => console.error("Firestore Error:", error));
                return () => unsubscribe();
            }, [user]);

            useEffect(() => {
                const now = new Date();
                const diff = Math.floor((now.getTime() - START_DATE.getTime()) / (1000 * 3600 * 24)) + 1;
                const current = Math.max(1, Math.min(diff, TOTAL_DAYS));
                setTodayNum(current);
                setViewDay(current);
            }, []);

            const updateStore = async (memberIdx, field, subKey, taskId, value) => {
                if (!user) return;
                const docRef = db.collection(`artifacts/${appId}/public/data/v2_challenges`).doc(memberIdx.toString());
                
                try {
                    let updateObj = {};
                    if (field === 'days' || field === 'atomic') {
                        const currentData = data[memberIdx] || {};
                        const fieldData = currentData[field] || {};
                        const dayData = fieldData[subKey] || {};
                        updateObj[field] = { ...fieldData, [subKey]: { ...dayData, [taskId]: value } };
                    } else {
                        const fieldData = (data[memberIdx] || {})[field] || {};
                        updateObj[field] = { ...fieldData, [taskId]: value };
                    }
                    await docRef.set(updateObj, { merge: true });
                } catch (err) { console.error("Update Error:", err); }
            };

            const leaderBoard = useMemo(() => {
                return MEMBERS.map((name, idx) => {
                    const mData = data[idx] || {};
                    let totalDaily = 0;
                    let totalAtomic = 0;
                    let totalChallenge = 0;
                    
                    if (mData.days) {
                        Object.values(mData.days).forEach(day => {
                            totalDaily += Object.values(day || {}).filter(v => v === true).length;
                        });
                    }
                    if (mData.atomic) {
                        Object.values(mData.atomic).forEach(day => {
                            totalAtomic += Object.values(day || {}).filter(v => v === true).length;
                        });
                    }
                    if (mData.longTerm) {
                        totalChallenge = Object.values(mData.longTerm).filter(v => v === true).length;
                    }
                    
                    const score = (totalDaily * 10) + (totalAtomic * 2) + (totalChallenge * 50);
                    return { name, idx, totalDaily, totalAtomic, totalChallenge, score };
                }).sort((a, b) => b.score - a.score);
            }, [data]);

            if (loading) return null; // Fallback loader sẽ xử lý phần này

            if (!isAuthenticated) return (
                <div className="min-h-screen flex items-center justify-center bg-stone-900 p-6">
                    <div className="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md text-center border-t-8 border-red-800 animate-in">
                        <div className="bg-red-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                            <Icon name="Lock" className="text-red-800" size={36} />
                        </div>
                        <h2 className="text-3xl font-black text-stone-800 mb-2 font-serif">ĐẠO TRÀNG XÓA ĐIẾC</h2>
                        <p className="text-stone-500 mb-8 text-sm italic">Nhập mật khẩu để bắt đầu hành trình</p>
                        <input 
                            type="password" 
                            value={passInput}
                            onChange={(e) => setPassInput(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && (passInput.toLowerCase() === PASSWORD ? setIsAuthenticated(true) : alert("Sai mật khẩu"))}
                            placeholder="Mật khẩu..."
                            className="w-full px-5 py-4 rounded-xl border-2 border-stone-100 mb-6 focus:border-red-800 outline-none text-center text-xl tracking-widest"
                        />
                        <button 
                            onClick={() => passInput.toLowerCase() === PASSWORD ? setIsAuthenticated(true) : alert("Sai mật khẩu")}
                            className="w-full bg-red-800 text-white py-4 rounded-xl font-bold hover:bg-red-900 transition-all"
                        >
                            VÀO HỆ THỐNG
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-stone-50 text-stone-900 pb-20">
                    <header className="bg-red-900 text-amber-50 py-12 px-6 text-center shadow-lg border-b-8 border-amber-500">
                        <h1 className="text-4xl md:text-5xl font-black mb-3 font-serif uppercase tracking-tight">HÀNH TRÌNH 60 NGÀY</h1>
                        <p className="opacity-70 text-sm uppercase tracking-[0.2em] font-light italic">Khai Mở Tâm Thức - Xóa Bỏ Vô Minh</p>
                    </header>

                    <nav className="sticky top-0 z-40 bg-white/95 backdrop-blur-md shadow-md flex overflow-x-auto no-scrollbar px-4 justify-center">
                        {[
                            { id: 'leaderboard', icon: 'Trophy', label: 'Bảng Vàng' },
                            { id: 'personal', icon: 'Flame', label: 'Tu Tập' },
                            { id: 'atomic', icon: 'Zap', label: 'Thói Quen' },
                            { id: 'challenges', icon: 'Target', label: 'Thử Thách' },
                        ].map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => setViewMode(tab.id)}
                                className={`px-6 py-5 flex items-center gap-2 font-bold text-xs uppercase tracking-widest transition-all relative ${viewMode === tab.id ? 'text-red-800' : 'text-stone-400 hover:text-stone-600'}`}
                            >
                                <Icon name={tab.icon} size={18} /> {tab.label}
                                {viewMode === tab.id && <div className="absolute bottom-0 left-0 w-full h-1 bg-red-800"></div>}
                            </button>
                        ))}
                    </nav>

                    <main className="max-w-5xl mx-auto px-4 mt-8">
                        {viewMode === 'leaderboard' && (
                            <div className="bg-white rounded-3xl shadow-xl overflow-hidden animate-in">
                                <div className="bg-amber-500 p-6 text-white flex justify-between items-center">
                                    <h2 className="text-2xl font-black font-serif uppercase tracking-tight">Xếp Hạng Tinh Tấn</h2>
                                    <Icon name="Medal" size={32} />
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left">
                                        <thead className="bg-stone-50 text-[10px] uppercase font-bold text-stone-400 tracking-widest border-b">
                                            <tr>
                                                <th className="px-6 py-4">Hạng</th>
                                                <th className="px-6 py-4">Pháp Hữu</th>
                                                <th className="px-6 py-4 text-center">Tổng Điểm</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-stone-100">
                                            {leaderBoard.map((item, i) => (
                                                <tr key={item.idx} className={i < 3 ? 'bg-amber-50/30' : ''}>
                                                    <td className="px-6 py-5 font-bold text-stone-400">{i + 1}</td>
                                                    <td className="px-6 py-5 font-bold text-stone-800">{item.name}</td>
                                                    <td className="px-6 py-5 text-center font-black text-red-800">{item.score}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {(viewMode === 'personal' || viewMode === 'atomic') && (
                            <div className="animate-in">
                                <div className="flex gap-2 overflow-x-auto no-scrollbar mb-6">
                                    {MEMBERS.map((m, i) => (
                                        <button key={i} onClick={() => setSelectedMember(i)} className={`px-4 py-2 rounded-full text-xs font-bold whitespace-nowrap transition-all ${selectedMember === i ? 'bg-red-800 text-white shadow-md' : 'bg-white text-stone-400 border border-stone-200'}`}>
                                            {m}
                                        </button>
                                    ))}
                                </div>
                                
                                <div className="bg-white p-6 rounded-3xl shadow-md border border-stone-100 mb-8 flex items-center justify-between">
                                    <button onClick={() => setViewDay(Math.max(1, viewDay - 1))} className="p-2 bg-stone-50 rounded-full"><Icon name="ChevronLeft"/></button>
                                    <div className="text-center">
                                        <p className="text-[10px] font-bold text-stone-400 uppercase tracking-widest">Tiến trình</p>
                                        <h3 className="text-xl font-black font-serif">Ngày {viewDay}</h3>
                                    </div>
                                    <button onClick={() => setViewDay(Math.min(todayNum, viewDay + 1))} className="p-2 bg-stone-50 rounded-full" disabled={viewDay >= todayNum}><Icon name="ChevronRight"/></button>
                                </div>

                                <div className="bg-stone-900 text-white p-8 rounded-3xl shadow-2xl border-t-8 border-amber-500">
                                    <h4 className="text-amber-500 font-black mb-6 flex items-center gap-2 font-serif uppercase tracking-widest">
                                        <Icon name={viewMode === 'personal' ? 'Flame' : 'Zap'} size={20}/>
                                        {viewMode === 'personal' ? 'Khóa Lễ Ngày' : 'Thói Quen Nhỏ'}
                                    </h4>
                                    <div className="space-y-4">
                                        {(viewMode === 'personal' ? [
                                            {id: 't1', label: 'Tịnh hóa Thân - Khẩu - Ý'},
                                            {id: 't2', label: 'Cúng khói & Lễ lạy'},
                                            {id: 't3', label: 'Giải phóng Âm thanh'},
                                            {id: 't4', label: 'Nghi quỹ 3Kaya'},
                                            {id: 't5', label: 'Thiền 10p & Quán tưởng'}
                                        ] : [
                                            {id: 'a1', label: 'Đánh răng'},
                                            {id: 'a2', label: 'Rửa mặt'},
                                            {id: 'a3', label: 'Đi bộ'},
                                            {id: 'a4', label: 'Uống nước'},
                                            {id: 'a5', label: 'Mặc áo'}
                                        ]).map(task => (
                                            <button
                                                key={task.id}
                                                onClick={() => updateStore(selectedMember, viewMode === 'personal' ? 'days' : 'atomic', viewDay, task.id, !((data[selectedMember] || {})[viewMode === 'personal' ? 'days' : 'atomic'] || {})[viewDay]?.[task.id])}
                                                className={`w-full flex items-center gap-4 p-4 rounded-2xl transition-all border-2 text-left ${
                                                    ((data[selectedMember] || {})[viewMode === 'personal' ? 'days' : 'atomic'] || {})[viewDay]?.[task.id] 
                                                    ? 'bg-amber-600/20 border-amber-500/50 text-amber-100' 
                                                    : 'bg-stone-800/50 border-stone-700/50 text-stone-500'
                                                }`}
                                            >
                                                <Icon name={((data[selectedMember] || {})[viewMode === 'personal' ? 'days' : 'atomic'] || {})[viewDay]?.[task.id] ? "CheckCircle2" : "Circle"} size={20} />
                                                <span className="font-bold text-sm">{task.label}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {viewMode === 'challenges' && (
                            <div className="max-w-md mx-auto animate-in">
                                <div className="bg-white p-8 rounded-3xl shadow-xl text-center border-t-8 border-red-800">
                                    <Icon name="Target" className="text-red-800 mx-auto mb-4" size={40} />
                                    <h3 className="text-2xl font-black font-serif uppercase mb-6">Thử Thách Dài Hạn</h3>
                                    <div className="space-y-3">
                                        {[
                                            {id: 'c1', label: 'Ngày ngủ 4 tiếng'},
                                            {id: 'c2', label: 'Ăn chay hoàn toàn'},
                                            {id: 'c3', label: 'Không ăn thịt đỏ'},
                                            {id: 'c4', label: 'Đủ 6 thời khóa'}
                                        ].map(ch => (
                                            <button
                                                key={ch.id}
                                                onClick={() => updateStore(selectedMember, 'longTerm', null, ch.id, !((data[selectedMember] || {}).longTerm || {})[ch.id])}
                                                className={`w-full p-5 rounded-2xl flex items-center gap-4 border-2 transition-all ${
                                                    ((data[selectedMember] || {}).longTerm || {})[ch.id] 
                                                    ? 'bg-amber-50 border-amber-500 text-amber-900 shadow-inner' 
                                                    : 'bg-stone-50 border-stone-100 text-stone-400'
                                                }`}
                                            >
                                                <Icon name={((data[selectedMember] || {}).longTerm || {})[ch.id] ? "CheckCircle2" : "Circle"} size={20} />
                                                <span className="font-bold">{ch.label}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    <footer className="mt-20 py-10 border-t border-stone-200 text-center opacity-30 text-[9px] uppercase tracking-[0.3em] font-bold text-stone-400 px-6">
                        Đạo Tràng Xóa Điếc &bull; Tinh Tấn Mỗi Ngày
                    </footer>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
