import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  doc, 
  setDoc, 
  onSnapshot, 
  collection, 
  query 
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  signInWithCustomToken, 
  onAuthStateChanged 
} from 'firebase/auth';
import { 
  CheckCircle2, 
  Circle, 
  Sun, 
  Moon, 
  Sunrise, 
  Flame, 
  User, 
  Calendar,
  Users,
  Trophy,
  Loader2,
  Lock,
  BookOpen,
  Zap,
  Target,
  ChevronLeft,
  ChevronRight,
  ArrowLeft,
  Medal,
  Star
} from 'lucide-react';

// --- CẤU HÌNH FIREBASE ---
const firebaseConfig = {
    apiKey: "AIzaSyC9NLtRzq6_pnt3-viN6a31WbLu_sMlGEI",
    authDomain: "day-challenge-39df2.firebaseapp.com",
    projectId: "day-challenge-39df2",
    storageBucket: "day-challenge-39df2.firebasestorage.app",
    messagingSenderId: "1083656610996",
    appId: "1:1083656610996:web:67780223432a21866323e1"
};

const firebaseApp = initializeApp(firebaseConfig);
const auth = getAuth(firebaseApp);
const db = getFirestore(firebaseApp);
const appId = "sixty-day-challenge-v1";

const App = () => {
  const TOTAL_DAYS = 60;
  const START_DATE = new Date('2026-01-23'); 
  const PASSWORD = "elephan";

  const MEMBERS = [
    "Bảo Bình", "Bình Minh", "Phượng", "Phương", 
    "Trang", "Điện", "Ánh Dương", "Thanh Thảo", 
    "Linh", "Quân", "Hằng"
  ];

  const DAILY_TASKS = [
    { id: 'tinh_hoa', label: 'Tịnh hóa Thân - Khẩu - Ý & Cầu Nguyện', session: 'morning_wake' },
    { id: 'cung_khoi', label: 'Cúng khói & Lễ lạy', session: 'morning_practice' },
    { id: 'khau_hanh', label: '4 Giới & 4 Thiện hạnh về Khẩu', session: 'daytime' },
    { id: 'am_thanh', label: 'Giải phóng cơ thể & Âm thanh', session: 'daytime' },
    { id: 'tri_chu', label: 'Nghi quỹ 3Kaya & Cúng Hộ Pháp', session: 'evening' },
    { id: 'thien_quan', label: 'Thiền 10p & Quán Đức Phổ Hiền', session: 'evening' }
  ];

  const ATOMIC_TASKS = [
    { id: 'at_rang', label: 'Đánh răng' },
    { id: 'at_mat', label: 'Rửa mặt' },
    { id: 'at_bo', label: 'Đi bộ' },
    { id: 'at_toc', label: 'Chải tóc' },
    { id: 'at_an', label: 'Ăn' },
    { id: 'at_uong', label: 'Uống' },
    { id: 'at_ao', label: 'Mặc quần áo' }
  ];

  const CHALLENGES = [
    { id: 'ch_ngu', label: 'Ngày ngủ 4 tiếng' },
    { id: 'ch_chay', label: 'Ăn đồ ăn chay' },
    { id: 'ch_thit', label: 'Không ăn thịt' },
    { id: 'ch_thoi', label: 'Ngày 6 thời khóa' }
  ];

  const MICRO_LEARNING = [
    { id: 'quy_y', title: 'Quy y', content: 'Quy y là đặt niềm tin trọn vẹn vào Tam Bảo: Phật, Pháp, Tăng. Đây là cánh cửa đầu tiên để bước vào con đường giác ngộ.' },
    { id: 'luc_do', title: 'Lục độ ba la mật', content: 'Sáu hạnh của Bồ tát: Bố thí, Trì giới, Nhẫn nhục, Tinh tấn, Thiền định, Trí tuệ.' },
    { id: 'ngoai_mat', title: 'Ngoại mật', content: 'Các pháp tu tập hướng về hình thức bên ngoài, tịnh hóa thân và môi trường xung quanh.' },
    { id: 'noi_mat', title: 'Nội mật', content: 'Các pháp tu tập sâu vào tâm thức, khí, mạch và minh điểm bên trong cơ thể.' }
  ];

  // States
  const [isAuthenticated, setIsAuthenticated] = useState(false);
  const [passInput, setPassInput] = useState("");
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [selectedMember, setSelectedMember] = useState(0);
  const [viewDay, setViewDay] = useState(1);
  const [todayNum, setTodayNum] = useState(1);
  const [data, setData] = useState({}); 
  const [viewMode, setViewMode] = useState('leaderboard'); // 'leaderboard', 'personal', 'atomic', 'learning', 'challenges'
  const [activeLesson, setActiveLesson] = useState(null);

  // 1. Auth & Firebase Initialization
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) { console.error(err); }
    };
    initAuth();
    onAuthStateChanged(auth, (u) => { setUser(u); setLoading(false); });
  }, []);

  // 2. Data Sync
  useEffect(() => {
    if (!user) return;
    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'v2_challenges'));
    return onSnapshot(q, (snapshot) => {
      const newData = {};
      snapshot.forEach((doc) => { newData[doc.id] = doc.data(); });
      setData(newData);
    }, (error) => {
      console.error("Firestore Error:", error);
    });
  }, [user]);

  // 3. Time Logic
  useEffect(() => {
    const calc = () => {
      const diff = Math.floor((new Date().getTime() - START_DATE.getTime()) / (1000 * 3600 * 24)) + 1;
      const current = Math.max(1, Math.min(diff, TOTAL_DAYS));
      setTodayNum(current);
      setViewDay(current);
    };
    calc();
  }, []);

  // 4. Update Logic
  const updateStore = async (memberIdx, field, subKey, taskId, value) => {
    if (!user) return;
    const memberDoc = data[memberIdx] || { days: {}, atomic: {}, longTerm: {} };
    
    let updated;
    if (field === 'days' || field === 'atomic') {
        const currentField = memberDoc[field] || {};
        const currentDay = currentField[subKey] || {};
        updated = { ...currentField, [subKey]: { ...currentDay, [taskId]: value } };
    } else {
        const currentField = memberDoc[field] || {};
        updated = { ...currentField, [taskId]: value };
    }

    try {
      await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'v2_challenges', memberIdx.toString()), { 
          [field]: updated 
      }, { merge: true });
    } catch (err) { console.error(err); }
  };

  // 5. Ranking Logic
  const leaderBoard = useMemo(() => {
    return MEMBERS.map((name, idx) => {
      const mData = data[idx] || {};
      let totalDaily = 0;
      let totalAtomic = 0;
      let totalChallenge = 0;

      // Tính tổng các ngày hoàn thành
      Object.values(mData.days || {}).forEach(day => {
          totalDaily += Object.values(day).filter(v => v).length;
      });
      Object.values(mData.atomic || {}).forEach(day => {
          totalAtomic += Object.values(day).filter(v => v).length;
      });
      totalChallenge = Object.values(mData.longTerm || {}).filter(v => v).length;

      const score = (totalDaily * 10) + (totalAtomic * 2) + (totalChallenge * 50);

      return { name, idx, totalDaily, totalAtomic, totalChallenge, score };
    }).sort((a, b) => b.score - a.score);
  }, [data]);

  const handleLogin = (e) => {
    e.preventDefault();
    if (passInput.toLowerCase() === PASSWORD) setIsAuthenticated(true);
    else alert("Mật khẩu không đúng!");
  };

  if (loading) return (
    <div className="min-h-screen flex items-center justify-center bg-stone-100">
        <Loader2 className="animate-spin text-red-800" size={40} />
    </div>
  );

  if (!isAuthenticated) return (
    <div className="min-h-screen flex items-center justify-center bg-stone-900 p-6">
      <form onSubmit={handleLogin} className="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md text-center">
        <div className="bg-red-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-6">
            <Lock className="text-red-800" size={32} />
        </div>
        <h2 className="text-2xl font-bold text-stone-800 mb-2">Đạo Tràng "Xóa Điếc"</h2>
        <p className="text-stone-500 mb-8 text-sm">Nhập mật khẩu để vào bên trong</p>
        <input 
          type="password" 
          value={passInput}
          onChange={(e) => setPassInput(e.target.value)}
          placeholder="Mật khẩu..."
          className="w-full px-4 py-3 rounded-lg border-2 border-stone-200 mb-4 focus:border-red-800 outline-none transition-all"
        />
        <button type="submit" className="w-full bg-red-800 text-white py-3 rounded-lg font-bold hover:bg-red-900 transition-colors">
          Khám Phá
        </button>
      </form>
    </div>
  );

  return (
    <div className="min-h-screen bg-stone-50 text-stone-900 pb-20 font-serif">
      {/* Header */}
      <header className="bg-red-900 text-amber-50 py-10 px-6 text-center shadow-lg border-b-4 border-amber-500">
        <h1 className="text-3xl md:text-5xl font-black mb-2 uppercase tracking-tighter">HÀNH TRÌNH 60 NGÀY</h1>
        <p className="opacity-70 text-sm md:text-base italic tracking-widest uppercase">Khai Mở Tâm Thức - Chặt Đứt Vòng Luân Hồi</p>
      </header>

      {/* Navigation */}
      <div className="sticky top-0 z-40 bg-white shadow-sm border-b overflow-x-auto flex no-scrollbar whitespace-nowrap">
        {[
            { id: 'leaderboard', icon: <Trophy size={18}/>, label: 'Bảng Vàng' },
            { id: 'personal', icon: <Flame size={18}/>, label: 'Tu Tập' },
            { id: 'atomic', icon: <Zap size={18}/>, label: 'Thói Quen' },
            { id: 'challenges', icon: <Target size={18}/>, label: 'Thử Thách' },
            { id: 'learning', icon: <BookOpen size={18}/>, label: 'Giáo Pháp' },
        ].map(tab => (
            <button
                key={tab.id}
                onClick={() => { setViewMode(tab.id); setActiveLesson(null); }}
                className={`px-6 py-4 flex items-center gap-2 font-bold text-xs uppercase tracking-widest transition-all ${viewMode === tab.id ? 'text-red-800 border-b-4 border-red-800 bg-red-50' : 'text-stone-400 hover:text-stone-600'}`}
            >
                {tab.icon} {tab.label}
            </button>
        ))}
      </div>

      <main className="max-w-6xl mx-auto px-4 mt-8">
        
        {/* LEADERBOARD VIEW */}
        {viewMode === 'leaderboard' && (
            <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
                <div className="bg-white rounded-2xl shadow-xl overflow-hidden border border-stone-200">
                    <div className="bg-amber-500 p-6 text-white flex justify-between items-center">
                        <h2 className="text-2xl font-bold flex items-center gap-2">BẢNG VÀNG CÔNG ĐỨC</h2>
                        <Star className="animate-pulse" />
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left">
                            <thead className="bg-stone-100 text-[10px] uppercase font-bold text-stone-500 tracking-widest">
                                <tr>
                                    <th className="px-6 py-4">Hạng</th>
                                    <th className="px-6 py-4">Pháp Hữu</th>
                                    <th className="px-6 py-4 text-center">Tu Tập (x10)</th>
                                    <th className="px-6 py-4 text-center">Thói Quen (x2)</th>
                                    <th className="px-6 py-4 text-center">Thử Thách (x50)</th>
                                    <th className="px-6 py-4 text-right">Tổng Điểm</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-stone-100">
                                {leaderBoard.map((item, i) => (
                                    <tr key={item.idx} className={`hover:bg-amber-50 transition-colors ${i === 0 ? 'bg-amber-50/30' : ''}`}>
                                        <td className="px-6 py-4">
                                            {i === 0 ? <Medal className="text-amber-500" /> : 
                                             i === 1 ? <Medal className="text-stone-400" /> :
                                             i === 2 ? <Medal className="text-amber-700" /> : 
                                             <span className="font-sans text-stone-400 font-bold ml-1">{i + 1}</span>}
                                        </td>
                                        <td className="px-6 py-4 font-bold text-stone-800">{item.name}</td>
                                        <td className="px-6 py-4 text-center font-sans">{item.totalDaily}</td>
                                        <td className="px-6 py-4 text-center font-sans">{item.totalAtomic}</td>
                                        <td className="px-6 py-4 text-center font-sans">{item.totalChallenge}</td>
                                        <td className="px-6 py-4 text-right font-black text-red-800 font-sans">{item.score.toLocaleString()}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        )}

        {/* PERSONAL/ATOMIC VIEW */}
        {(viewMode === 'personal' || viewMode === 'atomic') && (
            <div className="animate-in fade-in duration-300">
                <MemberSelector members={MEMBERS} selected={selectedMember} onSelect={setSelectedMember} />
                
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-6">
                    <div className="lg:col-span-2">
                        <div className="flex items-center justify-between mb-4 bg-white p-4 rounded-xl shadow-sm border">
                            <button onClick={() => setViewDay(Math.max(1, viewDay - 1))} className="p-2 hover:bg-stone-100 rounded-full transition-colors"><ChevronLeft/></button>
                            <span className="font-bold text-lg">Ngày {viewDay}</span>
                            <button onClick={() => setViewDay(Math.min(todayNum, viewDay + 1))} className="p-2 hover:bg-stone-100 rounded-full transition-colors" disabled={viewDay >= todayNum}><ChevronRight/></button>
                        </div>
                        
                        <div className="grid grid-cols-6 sm:grid-cols-10 gap-2 p-4 bg-white rounded-xl shadow-sm border">
                            {[...Array(TOTAL_DAYS)].map((_, i) => {
                                const dNum = i + 1;
                                const isCompleted = viewMode === 'personal' 
                                    ? Object.values(data[selectedMember]?.days?.[dNum] || {}).filter(v => v).length === DAILY_TASKS.length
                                    : Object.values(data[selectedMember]?.atomic?.[dNum] || {}).filter(v => v).length === ATOMIC_TASKS.length;

                                return (
                                    <button
                                        key={i}
                                        onClick={() => setViewDay(dNum)}
                                        disabled={dNum > todayNum}
                                        className={`aspect-square rounded text-[10px] font-bold border transition-all ${
                                            viewDay === dNum ? 'ring-2 ring-red-800 scale-110 z-10' : ''
                                        } ${dNum > todayNum ? 'opacity-20 cursor-not-allowed' : 
                                            isCompleted ? 'bg-amber-500 text-white border-amber-600' : 'bg-stone-50 text-stone-400 border-stone-200'}`}
                                    >
                                        {dNum}
                                    </button>
                                );
                            })}
                        </div>
                    </div>

                    <div className="bg-stone-800 text-stone-100 p-6 rounded-2xl shadow-xl h-fit border-t-4 border-amber-500">
                        <h3 className="text-xl font-bold mb-6 text-amber-400 flex items-center gap-2">
                            {viewMode === 'personal' ? <Flame size={20}/> : <Zap size={20}/>}
                            {viewMode === 'personal' ? 'Khóa Lễ Ngày' : 'Thói Quen Nhỏ'}
                        </h3>
                        
                        <div className="space-y-4">
                            {(viewMode === 'personal' ? DAILY_TASKS : ATOMIC_TASKS).map(task => (
                                <TaskItem 
                                    key={task.id}
                                    label={task.label}
                                    isChecked={data[selectedMember]?.[viewMode === 'personal' ? 'days' : 'atomic']?.[viewDay]?.[task.id]}
                                    onToggle={() => updateStore(
                                        selectedMember, 
                                        viewMode === 'personal' ? 'days' : 'atomic', 
                                        viewDay, 
                                        task.id, 
                                        !data[selectedMember]?.[viewMode === 'personal' ? 'days' : 'atomic']?.[viewDay]?.[task.id]
                                    )}
                                />
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        )}

        {/* CHALLENGES VIEW */}
        {viewMode === 'challenges' && (
            <div className="animate-in fade-in duration-300">
                <MemberSelector members={MEMBERS} selected={selectedMember} onSelect={setSelectedMember} />
                <div className="mt-8 max-w-2xl mx-auto">
                    <div className="bg-white p-8 rounded-2xl shadow-xl border-2 border-stone-100">
                        <div className="text-center mb-8">
                            <Target className="mx-auto text-red-800 mb-4" size={40} />
                            <h3 className="text-2xl font-bold">Thử Thách Vô Thường</h3>
                            <p className="text-stone-500 text-sm mt-2 italic">Những mục tiêu kiên định cần đạt được trong suốt 60 ngày</p>
                        </div>
                        <div className="space-y-4">
                            {CHALLENGES.map(ch => (
                                <button
                                    key={ch.id}
                                    onClick={() => updateStore(selectedMember, 'longTerm', null, ch.id, !data[selectedMember]?.longTerm?.[ch.id])}
                                    className={`w-full p-5 rounded-xl flex items-center gap-4 border-2 transition-all ${
                                        data[selectedMember]?.longTerm?.[ch.id] 
                                        ? 'bg-amber-50 border-amber-500 text-amber-900' 
                                        : 'bg-stone-50 border-stone-100 text-stone-500 hover:border-stone-200'
                                    }`}
                                >
                                    {data[selectedMember]?.longTerm?.[ch.id] ? <CheckCircle2 className="text-amber-500" /> : <Circle className="opacity-30" />}
                                    <span className="font-bold text-lg">{ch.label}</span>
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            </div>
        )}

        {/* MICRO LEARNING VIEW */}
        {viewMode === 'learning' && (
            <div className="animate-in fade-in duration-300">
                {!activeLesson ? (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {MICRO_LEARNING.map(lesson => (
                            <button
                                key={lesson.id}
                                onClick={() => setActiveLesson(lesson)}
                                className="bg-white p-8 rounded-2xl shadow-sm border-2 border-transparent hover:border-red-800 hover:shadow-xl transition-all text-left group"
                            >
                                <div className="bg-red-50 text-red-800 w-12 h-12 rounded-lg flex items-center justify-center mb-6 group-hover:scale-110 transition-transform">
                                    <BookOpen size={24} />
                                </div>
                                <h3 className="text-xl font-bold mb-2">{lesson.title}</h3>
                                <p className="text-stone-500 text-sm line-clamp-2">Tìm hiểu về bản chất và cách thực hành {lesson.title.toLowerCase()}.</p>
                                <div className="mt-6 flex items-center text-red-800 font-bold text-xs uppercase tracking-widest gap-2">
                                    Xem chi tiết <ChevronRight size={14} />
                                </div>
                            </button>
                        ))}
                    </div>
                ) : (
                    <div className="bg-white p-8 md:p-12 rounded-2xl shadow-xl border animate-in zoom-in-95 duration-300">
                        <button onClick={() => setActiveLesson(null)} className="flex items-center gap-2 text-stone-400 hover:text-red-800 mb-8 font-bold transition-colors">
                            <ArrowLeft size={18} /> QUAY LẠI DANH SÁCH
                        </button>
                        <h2 className="text-4xl font-black mb-8 border-b-4 border-amber-500 pb-4 inline-block">{activeLesson.title}</h2>
                        <div className="prose prose-stone max-w-none text-lg leading-relaxed text-stone-700 whitespace-pre-wrap">
                            {activeLesson.content}
                        </div>
                        <div className="mt-12 p-6 bg-stone-50 rounded-xl border border-stone-200 italic text-stone-500">
                            "Tri thức không đi đôi với thực hành giống như người mù cầm đèn pin soi đường cho kẻ khác."
                        </div>
                    </div>
                )}
            </div>
        )}

      </main>

      <footer className="mt-20 py-10 border-t border-stone-200 text-center opacity-30 text-[10px] tracking-[0.4em] uppercase">
        Nguyện đem công đức này &bull; Hướng về khắp tất cả &bull; Đệ tử và chúng sinh &bull; Đều trọn thành Phật đạo
      </footer>
    </div>
  );
};

const MemberSelector = ({ members, selected, onSelect }) => (
    <div className="bg-white p-2 rounded-2xl shadow-sm border flex gap-1 overflow-x-auto no-scrollbar">
        {members.map((m, i) => (
            <button
                key={i}
                onClick={() => onSelect(i)}
                className={`px-5 py-2.5 rounded-xl whitespace-nowrap text-xs font-bold transition-all ${
                    selected === i ? 'bg-red-800 text-white shadow-lg' : 'text-stone-500 hover:bg-stone-50'
                }`}
            >
                {m}
            </button>
        ))}
    </div>
);

const TaskItem = ({ label, isChecked, onToggle }) => (
    <button
        onClick={onToggle}
        className={`w-full flex items-start gap-3 p-3.5 rounded-xl transition-all border text-left ${
            isChecked ? 'bg-amber-600/20 border-amber-500/30 text-amber-100' : 'bg-stone-700/40 border-transparent text-stone-400 hover:bg-stone-700'
        }`}
    >
        <div className="mt-0.5">
            {isChecked ? <CheckCircle2 className="text-amber-500" size={18} /> : <Circle size={18} className="opacity-20" />}
        </div>
        <span className="text-sm font-medium leading-snug">{label}</span>
    </button>
);

export default App;
